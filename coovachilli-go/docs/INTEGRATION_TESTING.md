# Guide de Tests d'Int√©gration - CoovaChilli-Go

**Date:** 2025-10-05
**Version:** 1.0.0

---

## üìã Table des Mati√®res

- [Vue d'ensemble](#vue-densemble)
- [Architecture des tests](#architecture-des-tests)
- [Pr√©requis](#pr√©requis)
- [Ex√©cution locale](#ex√©cution-locale)
- [CI/CD Pipeline](#cicd-pipeline)
- [Sc√©narios de test](#sc√©narios-de-test)
- [D√©pannage](#d√©pannage)
- [Contribution](#contribution)

---

## üìñ Vue d'ensemble

Cette suite de tests d'int√©gration valide le fonctionnement complet de CoovaChilli-Go en simulant un environnement de production r√©el avec :

- **Clients r√©els** obtenant des adresses IP via DHCP
- **Authentification RADIUS** via FreeRADIUS
- **Portail captif** avec redirection HTTP
- **Firewall** iptables et ufw
- **Dual-stack** IPv4 et IPv6
- **M√©triques** Prometheus
- **API d'administration**

### Matrice de tests

| Test Suite | IPv4 | IPv6 | iptables | ufw | Status |
|------------|------|------|----------|-----|--------|
| IPv4 + iptables | ‚úÖ | ‚ùå | ‚úÖ | ‚ùå | Production |
| IPv6 + iptables | ‚ùå | ‚úÖ | ‚úÖ | ‚ùå | Production |
| IPv4 + ufw | ‚úÖ | ‚ùå | ‚ùå | ‚úÖ | Production |
| IPv6 + ufw | ‚ùå | ‚úÖ | ‚ùå | ‚úÖ | Production |

**Total : 4 configurations test√©es automatiquement**

---

## üèóÔ∏è Architecture des tests

### Composants Docker

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     Integration Test Suite                   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                               ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ  FreeRADIUS  ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§ CoovaChilli  ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§  Client   ‚îÇ ‚îÇ
‚îÇ  ‚îÇ   (Auth)     ‚îÇ      ‚îÇ   Gateway    ‚îÇ      ‚îÇ  (DHCP)   ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ         ‚îÇ                      ‚îÇ                     ‚îÇ       ‚îÇ
‚îÇ         ‚îÇ                      ‚îÇ                     ‚îÇ       ‚îÇ
‚îÇ         ‚ñº                      ‚ñº                     ‚ñº       ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ  Test Users  ‚îÇ      ‚îÇ  Firewall    ‚îÇ      ‚îÇ  Test Web ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  Database    ‚îÇ      ‚îÇ(iptables/ufw)‚îÇ      ‚îÇ  Server   ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                                               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Flux de test complet

1. **D√©marrage des services**
   - FreeRADIUS d√©marre avec base d'utilisateurs de test
   - Serveur web nginx d√©marre pour simuler internet
   - CoovaChilli d√©marre avec iptables ou ufw

2. **Client obtient une IP**
   - Client envoie DHCP DISCOVER
   - CoovaChilli r√©pond avec DHCP OFFER
   - Client configure son interface r√©seau

3. **Redirection portail captif**
   - Client tente d'acc√©der √† internet
   - Firewall redirige vers le portail captif
   - Client re√ßoit page de login

4. **Authentification RADIUS**
   - Client soumet credentials au portail
   - CoovaChilli envoie Access-Request √† RADIUS
   - RADIUS valide et renvoie Access-Accept
   - Session cr√©√©e avec attributs RADIUS

5. **Acc√®s internet**
   - Firewall autorise le trafic du client
   - Client peut acc√©der au web
   - Accounting RADIUS commence

6. **V√©rifications**
   - Session status API
   - M√©triques Prometheus
   - R√®gles firewall
   - Bande passante

---

## üîß Pr√©requis

### Logiciels requis

```bash
# Docker et Docker Compose
docker --version  # >= 24.0.0
docker compose version  # >= 2.20.0

# Pour les tests locaux
bash >= 4.0
jq >= 1.6
curl
```

### Configuration Docker pour IPv6

√âditer `/etc/docker/daemon.json` :

```json
{
  "ipv6": true,
  "fixed-cidr-v6": "2001:db8:1::/64",
  "experimental": true,
  "ip6tables": true
}
```

Red√©marrer Docker :

```bash
sudo systemctl restart docker
```

### Permissions

Les tests n√©cessitent des privil√®ges pour :
- Cr√©er des interfaces TUN/TAP
- Modifier les r√®gles iptables/ufw
- G√©rer le routage r√©seau

Les conteneurs utilisent `privileged: true` et `cap_add: [NET_ADMIN, NET_RAW]`.

---

## üöÄ Ex√©cution locale

### M√©thode rapide

```bash
cd test/integration
./run_tests_local.sh
```

Cette commande ex√©cute tous les tests (IPv4, IPv6, iptables, ufw).

### Tests s√©lectifs

```bash
# Tests IPv4 uniquement
./run_tests_local.sh ipv4

# Tests IPv6 uniquement
./run_tests_local.sh ipv6

# Tests iptables uniquement
./run_tests_local.sh iptables

# Tests ufw uniquement
./run_tests_local.sh ufw

# Test sp√©cifique
./run_tests_local.sh ipv4-iptables

# Sans cleanup (pour debugging)
./run_tests_local.sh ipv4-iptables no
```

### Utilisation manuelle de Docker Compose

```bash
cd test/integration

# Build des images
docker compose -f docker-compose.e2e.yml build

# D√©marrer les services
docker compose -f docker-compose.e2e.yml up -d radius webserver chilli-iptables

# V√©rifier les logs
docker compose -f docker-compose.e2e.yml logs -f chilli-iptables

# Lancer le client de test
docker compose -f docker-compose.e2e.yml run --rm client-iptables-ipv4

# R√©cup√©rer les r√©sultats
docker compose -f docker-compose.e2e.yml cp client-iptables-ipv4:/results/. ./results/

# Nettoyer
docker compose -f docker-compose.e2e.yml down -v
```

### Debugging interactif

```bash
# D√©marrer les services
docker compose -f docker-compose.e2e.yml up -d radius webserver chilli-iptables

# Ouvrir un shell dans le client
docker compose -f docker-compose.e2e.yml run --rm client-iptables-ipv4 /bin/bash

# Dans le conteneur client :
root@client:/tests# dhclient -v eth0
root@client:/tests# ip addr show
root@client:/tests# curl http://192.168.100.200/test
root@client:/tests# /tests/run_e2e_tests.sh
```

---

## ‚öôÔ∏è CI/CD Pipeline

### GitHub Actions

Le workflow `.github/workflows/integration-tests.yml` s'ex√©cute automatiquement sur :

- **Push** sur `master` ou `develop`
- **Pull Request** vers `master` ou `develop`
- **Schedule** quotidien √† 2h UTC
- **Manuel** via workflow_dispatch

### Jobs du pipeline

1. **unit-tests** (requis)
   - Tests unitaires avec race detector
   - Couverture de code upload√©e √† Codecov

2. **integration-ipv4-iptables**
   - Tests IPv4 avec firewall iptables
   - 12 tests de bout en bout

3. **integration-ipv6-iptables**
   - Tests IPv6 avec firewall iptables
   - Validation dual-stack

4. **integration-ipv4-ufw**
   - Tests IPv4 avec firewall ufw
   - Compatibilit√© ufw

5. **integration-ipv6-ufw**
   - Tests IPv6 avec firewall ufw
   - Validation compl√®te ufw + IPv6

6. **aggregate-results**
   - Agr√®ge tous les r√©sultats
   - G√©n√®re rapport markdown
   - Commente automatiquement les PR

### Artefacts g√©n√©r√©s

- `integration-results-ipv4-iptables` - R√©sultats JSON IPv4 iptables
- `integration-results-ipv6-iptables` - R√©sultats JSON IPv6 iptables
- `integration-results-ipv4-ufw` - R√©sultats JSON IPv4 ufw
- `integration-results-ipv6-ufw` - R√©sultats JSON IPv6 ufw
- `test-summary` - Rapport agr√©g√© markdown

### Temps d'ex√©cution

| Job | Dur√©e moyenne |
|-----|---------------|
| unit-tests | 2-3 min |
| integration-ipv4-iptables | 3-4 min |
| integration-ipv6-iptables | 3-4 min |
| integration-ipv4-ufw | 3-4 min |
| integration-ipv6-ufw | 3-4 min |
| aggregate-results | 1 min |
| **TOTAL** | **~15-20 min** |

---

## üß™ Sc√©narios de test

### Tests ex√©cut√©s pour chaque configuration

#### 1. Network Interface Check
- V√©rifie la pr√©sence d'interface r√©seau
- IPv4 : interface avec adresse `inet`
- IPv6 : interface avec adresse `inet6`

#### 2. DHCP IP Allocation
- **IPv4** : `dhclient` obtient une adresse dans 10.x.0.100-200
- **IPv6** : `dhclient -6` obtient une adresse dans fd01:x::100-200
- Validation du lease DHCP
- V√©rification DNS serveurs assign√©s

#### 3. DNS Resolution
- R√©solution de `google.com`
- V√©rification serveurs DNS CoovaChilli
- Validation walled garden DNS

#### 4. Internet Blocked Before Auth
- Tentative d'acc√®s au serveur web
- Doit √©chouer ou rediriger
- Validation de l'isolation firewall

#### 5. Captive Portal Redirect
- Requ√™te HTTP vers internet
- Redirection vers portail captif
- V√©rification page de login

#### 6. RADIUS Authentication
- Soumission credentials `testuser/testpass`
- Validation Access-Accept RADIUS
- Cr√©ation de session
- R√©ception attributs RADIUS (timeout, bande passante)

#### 7. Internet Access After Auth
- Acc√®s au serveur web de test
- V√©rification HTTP 200
- Validation bande passante

#### 8. Firewall Rules
- V√©rification isolation client
- Validation r√®gles NAT
- Test forwarding IPv4/IPv6

#### 9. Session Status API
- GET `/json/status?callback=getStatus`
- Validation JSONP response
- V√©rification donn√©es session

#### 10. Bandwidth Test
- Download fichier 10MB
- Mesure vitesse
- Validation limites RADIUS

#### 11. Metrics Endpoint
- GET `/metrics` Prometheus
- Validation m√©triques `chilli_*`
- V√©rification compteurs

#### 12. Admin API
- GET `/api/v1/sessions`
- Validation authentification token
- V√©rification liste sessions

### Utilisateurs de test RADIUS

| Username | Password | Session Timeout | Bandwidth Down | Bandwidth Up |
|----------|----------|-----------------|----------------|--------------|
| testuser | testpass | 3600s | 10 Mbps | 10 Mbps |
| limiteduser | limitedpass | 1800s | 1 Mbps | 512 Kbps |
| shortuser | shortpass | 300s | Unlimited | Unlimited |
| ipv6user | ipv6pass | 3600s | 10 Mbps | 10 Mbps |
| rejectuser | rejectpass | - | REJECT | REJECT |

---

## üêõ D√©pannage

### Probl√®me : Tests √©chouent avec "Network unreachable"

**Cause :** IPv6 non configur√© dans Docker

**Solution :**
```bash
# V√©rifier config Docker
docker network inspect bridge | grep IPv6

# Si false, √©diter /etc/docker/daemon.json
sudo nano /etc/docker/daemon.json

# Ajouter :
{
  "ipv6": true,
  "fixed-cidr-v6": "2001:db8:1::/64"
}

# Red√©marrer
sudo systemctl restart docker
```

### Probl√®me : "Cannot create TUN device"

**Cause :** Privil√®ges insuffisants ou module kernel manquant

**Solution :**
```bash
# Charger module TUN
sudo modprobe tun

# V√©rifier
lsmod | grep tun

# Dans docker-compose, v√©rifier :
privileged: true
cap_add:
  - NET_ADMIN
  - NET_RAW
```

### Probl√®me : RADIUS authentication fails

**Cause :** Secret RADIUS incorrect ou serveur RADIUS non disponible

**Solution :**
```bash
# V√©rifier logs RADIUS
docker compose -f test/integration/docker-compose.e2e.yml logs radius

# Tester RADIUS manuellement
docker compose exec radius radtest testuser testpass localhost 0 testing123

# V√©rifier config client RADIUS
docker compose exec radius cat /etc/raddb/clients.conf
```

### Probl√®me : Firewall rules not applied

**Cause :** Backend firewall non disponible ou permissions insuffisantes

**Solution :**
```bash
# V√©rifier logs CoovaChilli
docker compose logs chilli-iptables | grep -i firewall

# V√©rifier r√®gles iptables dans le conteneur
docker compose exec chilli-iptables iptables -L -n -v
docker compose exec chilli-iptables ip6tables -L -n -v

# Pour ufw
docker compose exec chilli-ufw ufw status verbose
```

### Probl√®me : DHCP lease fails

**Cause :** Conflit d'adresse IP ou serveur DHCP non √©coutant

**Solution :**
```bash
# V√©rifier logs DHCP dans CoovaChilli
docker compose logs chilli-iptables | grep -i dhcp

# Dans le client, activer debug DHCP
docker compose run --rm client-iptables-ipv4 dhclient -d -v eth0

# V√©rifier interface r√©seau
docker compose exec chilli-iptables ip addr show
```

### Probl√®me : Tests passent localement mais √©chouent en CI

**Cause :** Timing diff√©rent, ressources limit√©es, ou IPv6 non configur√©

**Solution :**
```bash
# Augmenter les timeouts dans run_e2e_tests.sh
# Actuellement : timeout 30

# Ajouter plus de waits
sleep 15  # Augmenter √† 30

# V√©rifier logs GitHub Actions
# Onglet Actions > Workflow run > Job logs
```

### Logs utiles pour debugging

```bash
# Tous les logs
docker compose -f test/integration/docker-compose.e2e.yml logs

# Logs d'un service sp√©cifique
docker compose logs chilli-iptables
docker compose logs radius
docker compose logs client-iptables-ipv4

# Logs en temps r√©el
docker compose logs -f chilli-iptables

# Derni√®res 100 lignes
docker compose logs --tail=100 chilli-iptables

# Sauvegarder tous les logs
docker compose logs > full-logs.txt
```

---

## üîç Analyse des r√©sultats

### Format JSON des r√©sultats

Les r√©sultats sont sauvegard√©s dans `/results/` avec le format :

```json
{
  "test_type": "ipv4",
  "firewall": "iptables",
  "timestamp": "2025-10-05T10:30:00Z",
  "tests": [
    {
      "name": "DHCP IP Allocation",
      "status": "pass",
      "duration_ms": 1234,
      "message": "Test passed successfully"
    }
  ],
  "summary": {
    "total": 12,
    "passed": 12,
    "failed": 0,
    "success_rate": "100.00%"
  }
}
```

### Extraction des m√©triques

```bash
# Taux de succ√®s global
jq '.summary.success_rate' results/*.json

# Nombre de tests √©chou√©s
jq '.summary.failed' results/*.json | awk '{s+=$1} END {print s}'

# Tests les plus lents
jq -r '.tests[] | "\(.duration_ms) ms - \(.name)"' results/*.json | sort -rn | head -5

# Tests √©chou√©s seulement
jq -r '.tests[] | select(.status == "fail") | .name' results/*.json
```

---

## üìä M√©triques de qualit√©

### Crit√®res de succ√®s

Pour qu'une PR soit mergeable :

- ‚úÖ **100%** des tests unitaires passent
- ‚úÖ **‚â• 90%** des tests d'int√©gration IPv4 passent
- ‚úÖ **‚â• 80%** des tests d'int√©gration IPv6 passent
- ‚úÖ **Pas de r√©gression** de couverture de code
- ‚úÖ **Pas de race conditions** d√©tect√©es

### Couverture de code

La couverture globale doit √™tre ‚â• 36% (objectif : 50%).

```bash
# G√©n√©rer rapport de couverture
go test ./pkg/... -coverprofile=coverage.out
go tool cover -html=coverage.out -o coverage.html
```

### Performance

Les benchmarks doivent rester dans les limites :

| Op√©ration | Max Time | Max Allocs |
|-----------|----------|------------|
| CreateSession | 10 ¬µs | 5 allocs |
| GetSessionByIP | 1 ¬µs | 0 allocs |
| DHCP Request | 100 ms | - |
| RADIUS Auth | 500 ms | - |

---

## ü§ù Contribution

### Ajouter un nouveau test

1. √âditer `test/integration/tests/run_e2e_tests.sh`
2. Ajouter une fonction `test_nouvelle_feature()`
3. Appeler via `run_test "Nom du test" test_nouvelle_feature`

Exemple :

```bash
test_session_timeout() {
    log_info "Testing session timeout..."

    # Attendre timeout + 10s
    sleep 610

    # V√©rifier que la session est expir√©e
    if ! curl -s "http://${WEB_HOST}/test" | grep -q "Test successful"; then
        log_success "Session correctly expired"
        return 0
    fi

    log_error "Session did not expire"
    return 1
}

# Dans main :
run_test "Session Timeout" test_session_timeout
```

### Ajouter une configuration de test

1. Cr√©er nouveau fichier `config.nouvelle.yaml`
2. Ajouter service dans `docker-compose.e2e.yml`
3. Cr√©er client de test correspondant
4. Ajouter job dans `.github/workflows/integration-tests.yml`

### Guidelines de test

- ‚úÖ Tests doivent √™tre **idempotents** (r√©p√©tables)
- ‚úÖ Tests doivent √™tre **isol√©s** (pas de d√©pendances entre tests)
- ‚úÖ Tests doivent **nettoyer** leurs ressources
- ‚úÖ Timeouts doivent √™tre **raisonnables** (max 60s par test)
- ‚úÖ Messages de log doivent √™tre **clairs** et **actionnables**
- ‚úÖ Tests doivent g√©rer les **edge cases**

---

## üìö R√©f√©rences

- [Docker Compose Reference](https://docs.docker.com/compose/)
- [FreeRADIUS Documentation](https://freeradius.org/documentation/)
- [GitHub Actions Workflow Syntax](https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions)
- [CoovaChilli Configuration](../README.md)
- [RADIUS Protocol RFC 2865](https://tools.ietf.org/html/rfc2865)

---

## üìù Changelog

### Version 1.0.0 (2025-10-05)

- ‚úÖ Suite compl√®te de tests d'int√©gration
- ‚úÖ Support IPv4 et IPv6
- ‚úÖ Support iptables et ufw
- ‚úÖ Pipeline CI/CD GitHub Actions
- ‚úÖ Documentation compl√®te
- ‚úÖ 12 sc√©narios de test par configuration
- ‚úÖ 4 configurations test√©es (IPv4/IPv6 √ó iptables/ufw)
- ‚úÖ R√©sultats JSON structur√©s
- ‚úÖ Rapport agr√©g√© automatique

---

**Maintenu par :** CoovaChilli-Go Team
**Licence :** M√™me que le projet principal
**Derni√®re mise √† jour :** 2025-10-05
